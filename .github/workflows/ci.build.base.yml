name: CI / Build / Base Containers

on:
  push:
    branches:
      - main
      - fix-linter
    # paths:
    #   - Gemfile.lock
    #   - platform/docker/Dockerfile.builder
    #   - platform/docker/Dockerfile.intermediate
# env:
#   RUBY_VERSION: 3.0.3
#   # NODE_VERSION: '16.x'
#   BUILD_MODE: true
#   DOCKER_REPO_ORG: ghcr.io/houseninjadojo

jobs:
  base:
    name: Base
    # runs-on: ubuntu-latest
    uses: ./.github/workflows/reusable.build.yml@v1
    with:
      docker_repo: ghcr.io/houseninjadojo/api-base
      build_args: RAILS_MASTER_KEY=${{ secrets.RAILS_TEST_MASTER_KEY }}
      dockerfile: platform/docker/Dockerfile.builder
    # steps:
    #   -
    #     name: Checkout
    #     uses: actions/checkout@v2
    #   - 
    #     uses: houseninjadojo/api/.github/workflows/reusable.build.yml@v1
    #     with:
    #       docker_repo: ghcr.io/houseninjadojo/api-base
    #       build_args: RAILS_MASTER_KEY=${{ secrets.RAILS_TEST_MASTER_KEY }}
    #       dockerfile: platform/docker/Dockerfile.builder
  intermediate:
    name: Intermediate
    # runs-on: ubuntu-latest
    uses: ./.github/workflows/reusable.build.yml@v1
    with:
      docker_repo: ghcr.io/houseninjadojo/api-intermediate
      build_args: RAILS_MASTER_KEY=${{ secrets.RAILS_TEST_MASTER_KEY }}
      dockerfile: platform/docker/Dockerfile.intermediate
    # steps:
    #   -
    #     name: Checkout
    #     uses: actions/checkout@v2
    #   - 
    #     uses: houseninjadojo/api/.github/workflows/reusable.build.yml@v1
    #     with:
    #       docker_repo: ghcr.io/houseninjadojo/api-intermediate
    #       build_args: RAILS_MASTER_KEY=${{ secrets.RAILS_TEST_MASTER_KEY }}
    #       dockerfile: platform/docker/Dockerfile.intermediate
      # -
      #   name: Checkout
      #   uses: actions/checkout@v2
      # -
      #   name: Set up QEMU
      #   uses: docker/setup-qemu-action@v1
      # - 
      #   name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@v1
      # -
      #   name: Cache Docker layers
      #   uses: actions/cache@v2
      #   with:
      #     path: /tmp/.buildx-cache
      #     key: ${{ runner.os }}-buildx-${{ github.sha }}
      #     restore-keys: |
      #       ${{ runner.os }}-buildx-
      # - 
      #   name: Login to GitHub Container Registry
      #   uses: docker/login-action@v1
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.repository_owner }}
      #     password: ${{ secrets.GITHUB_TOKEN }}
      # -
      #   name: Build and push `houseninja-api-builder` image
      #   uses: docker/build-push-action@v2
      #   with:
      #     context: .
      #     platforms: linux/amd64,linux/arm64
      #     push: true
      #     build-args: |
      #       RAILS_MASTER_KEY=${{ secrets.RAILS_TEST_MASTER_KEY }}
      #     file: platform/docker/Dockerfile.builder
      #     tags: ${{ env.DOCKER_REPO_ORG }}/houseninja-api-builder:latest
      #     cache-from: type=local,src=/tmp/.buildx-cache
      #     cache-to: type=local,dest=/tmp/.buildx-cache-new
      # -
      #   name: Build and push `houseninja-api-intermediate` image
      #   uses: docker/build-push-action@v2
      #   with:
      #     context: .
      #     platforms: linux/amd64,linux/arm64
      #     push: true
      #     file: platform/docker/Dockerfile.intermediate
      #     tags: ${{ env.DOCKER_REPO_ORG }}/houseninja-api-intermediate:latest
      #     cache-from: type=local,src=/tmp/.buildx-cache
      #     cache-to: type=local,dest=/tmp/.buildx-cache-new
      # -
      #   # Temp fix
      #   # https://github.com/docker/build-push-action/issues/252
      #   # https://github.com/moby/buildkit/issues/1896
      #   name: Move cache
      #   run: |
      #     rm -rf /tmp/.buildx-cache
      #     mv /tmp/.buildx-cache-new /tmp/.buildx-cache